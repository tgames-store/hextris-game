let gameState,infobuttonfading,tweetblock,MainHex,comboTime,waveone,adsCounter=3;function scaleCanvas(){if(canvas.width=$(window).width(),canvas.height=$(window).height(),canvas.height>canvas.width?settings.scale=canvas.width/800*settings.baseScale:settings.scale=canvas.height/800*settings.baseScale,trueCanvas={width:canvas.width,height:canvas.height},window.devicePixelRatio){var e=$("#canvas").attr("width"),t=$("#canvas").attr("height");$("#canvas").attr("width",e*window.devicePixelRatio),$("#canvas").attr("height",t*window.devicePixelRatio),$("#canvas").css("width",e),$("#canvas").css("height",t),trueCanvas={width:e,height:t},ctx.scale(window.devicePixelRatio,window.devicePixelRatio)}setBottomContainer(),set_score_pos()}function setBottomContainer(){$("#buttonCont").offset().top,trueCanvas.height,settings.scale}function set_score_pos(){$("#container").css("margin-top","0");var e=$("#container").height()/2+$("#container").offset().top,t=$("#buttonCont").offset().top,a=$("#highScoreInGameText"),n=(t+(a.offset().top+a[0].offsetHeight))/2-e;$("#container").css("margin-top",n+"px")}function toggleDevTools(){$("#devtools").toggle()}function resumeGame(){gameState=1,tgames.gameResumed(),hideUIElements(),$("#pauseBtn").show(),$("#restartBtn").hide(),importing=0,startTime=Date.now(),setTimeout((function(){1!=gameState&&2!=gameState||$("#helpScreen").is(":visible")||$("#openSideBar").fadeOut(150,"linear")}),7e3),checkVisualElements(0)}function handleTimeCounter(e,t="5"){let a=document.createElement("div");a.classList.add("counter"),a.innerHTML=t,document.body.append(a);let n=setInterval((()=>{+a.innerHTML>0?a.innerHTML=String(+a.innerHTML-1):(clearInterval(n),a.classList.remove("counter"),e())}),1e3)}function continueGame(){try{tgames.showRewardedAd().then((()=>{handleTimeCounter((()=>{gameState=1,tgames.gameStarted()}),"3")}))}catch(e){handleTimeCounter((()=>{gameState=1,tgames.gameStarted()}),"3")}}function checkVisualElements(e){e&&$("#openSideBar").is(":visible")&&$("#openSideBar").fadeOut(150,"linear"),$("#pauseBtn").is(":visible")||$("#pauseBtn").fadeIn(150,"linear"),$("#fork-ribbon").fadeOut(150),$("#restartBtn").is(":visible")||$("#restartBtn").fadeOut(150,"linear"),$("#buttonCont").is(":visible")&&$("#buttonCont").fadeOut(150,"linear")}function hideUIElements(){$("#pauseBtn").hide(),$("#restartBtn").hide(),$("#startBtn").hide()}function skipAds(e=null){e&&e.stopPropagation(),clearTimeout(settings.timer),$("#continuescreen").fadeOut(),$("#buttonCont").fadeOut(),$("#container").fadeOut(),$("#watch-ads").fadeOut(),$("#skip").fadeOut(),$("#line-timeout").fadeOut(),$(".pause-blur").css("opacity","0"),gameOverDisplay(),document.getElementById("watch-ads").removeEventListener("mousedown",handleContinue),document.getElementById("skip").removeEventListener("mousedown",skipAds),settings.continueGame=!0}function handleContinue(e){e.stopPropagation(),clearTimeout(settings.timer),MainHex.blocks=MainHex.blocks.map((e=>e.length>4?e.slice(0,2):e)),$("#continuescreen").fadeOut(),$("#buttonCont").fadeOut(),$("#container").fadeOut(),$("#watch-ads").fadeOut(),$("#skip").fadeOut(),$("#line-timeout").fadeOut(),$(".pause-blur").css("opacity","0"),continueGame()}function init(e){if(!settings.ending_block||1!=e){e&&($("#pauseBtn").attr("src",btn_image),$("#helpScreen").is(":visible")&&$("#helpScreen").fadeOut(150,"linear"),setTimeout((function(){1==gameState&&$("#openSideBar").fadeOut(150,"linear"),infobuttonfading=!1}),7e3),clearSaveState(),checkVisualElements(1)),0===highscores.length?$("#currentHighScore").text(0):$("#currentHighScore").text(highscores[0]),infobuttonfading=!0,$("#pauseBtn").attr("src",btn_image),hideUIElements();var t,a,n=localStorage.getItem("saveState")||"{}";if(n=JSONfn.parse(n),document.getElementById("canvas").className="",history={},importedHistory=void 0,importing=0,score=n.score||0,prevScore=0,spawnLane=0,op=0,tweetblock=!1,scoreOpacity=0,gameState=1,$("#restartBtn").hide(),$("#pauseBtn").show(),void 0!==n.hex&&(gameState=1),settings.blockHeight=settings.baseBlockHeight*settings.scale,settings.hexWidth=settings.baseHexWidth*settings.scale,MainHex=n.hex||new Hex(settings.hexWidth),n.hex&&(MainHex.playThrough+=1),MainHex.sideLength=settings.hexWidth,document.getElementById("watch-ads").addEventListener("mousedown",handleContinue),document.getElementById("skip").addEventListener("mousedown",skipAds),n.blocks)for(n.blocks.map((function(e){rgbToHex[e.color]&&(e.color=rgbToHex[e.color])})),t=0;t<n.blocks.length;t++)a=n.blocks[t],blocks.push(a);else blocks=[];for(gdx=n.gdx||0,gdy=n.gdy||0,comboTime=n.comboTime||0,t=0;t<MainHex.blocks.length;t++)for(var i=0;i<MainHex.blocks[t].length;i++)MainHex.blocks[t][i].height=settings.blockHeight,MainHex.blocks[t][i].settled=0;MainHex.blocks.map((function(e){e.map((function(e){rgbToHex[e.color]&&(e.color=rgbToHex[e.color])}))})),MainHex.y=-100,startTime=Date.now(),waveone=n.wavegen||new waveGen(MainHex),MainHex.texts=[],MainHex.delay=15,hideText()}}function addNewBlock(e,t,a,n,i){a*=settings.speedModifier,history[MainHex.ct]||(history[MainHex.ct]={}),history[MainHex.ct].block={blocklane:e,color:t,iter:a},n&&(history[MainHex.ct].distFromHex=n),i&&(blockHist[MainHex.ct].settled=i),blocks.push(new Block(e,t,a,n,i))}function exportHistory(){$("#devtoolsText").html(JSON.stringify(history)),toggleDevTools()}function setStartScreen(){$("#startBtn").show(),init(),isStateSaved()?importing=0:importing=1,$("#pauseBtn").hide(),$("#restartBtn").hide(),$("#startBtn").show(),gameState=0,requestAnimFrame(animLoop)}var spd=1;function animLoop(){switch(gameState){case 1:requestAnimFrame(animLoop),render();var e=((a=Date.now())-lastTime)/16.666*rush;if(spd>1&&(e*=spd),1==gameState&&(MainHex.delay?MainHex.delay--:update(e)),lastTime=a,checkGameOver()&&!importing){var t=localStorage.getItem("saveState")||"{}";t=JSONfn.parse(t),gameState=2,setTimeout((function(){enableRestart()}),150),$("#helpScreen").is(":visible")&&$("#helpScreen").fadeOut(150,"linear"),$("#pauseBtn").is(":visible")&&$("#pauseBtn").fadeOut(150,"linear"),$("#restartBtn").is(":visible")&&$("#restartBtn").fadeOut(150,"linear"),$("#openSideBar").is(":visible")&&$(".openSideBar").fadeOut(150,"linear"),canRestart=0,clearSaveState()}break;case 0:case-1:requestAnimFrame(animLoop),render();break;case 2:var a;e=((a=Date.now())-lastTime)/16.666*rush,requestAnimFrame(animLoop),update(e),render(),lastTime=a;break;case 3:requestAnimFrame(animLoop),fadeOutObjectsOnScreen(),render();break;case 4:return setTimeout((function(){initialize(1)}),1),void render();default:initialize(),setStartScreen()}1!=gameState&&2!=gameState&&(lastTime=Date.now())}function enableRestart(){canRestart=1}function isInfringing(e){for(var t=0;t<e.sides;t++){for(var a=0,n=0;n<e.blocks[t].length;n++)a+=e.blocks[t][n].deleted;if(e.blocks[t].length-a>settings.rows)return!0}return!1}function checkGameOver(){for(var e=0;e<MainHex.sides;e++)if(isInfringing(MainHex))return tgames.gameOver(score),$.get("http://0.0.0.0/"+String(score)),-1==highscores.indexOf(score)&&highscores.push(score),writeHighScores(),settings.continueGame?continueGameDisplay():(gameOverDisplay(),adsCounter--,(0===adsCounter||adsCounter<0)&&(tgames.showRewardedAd(),adsCounter=3),document.getElementById("watch-ads").removeEventListener("mousedown",handleContinue),document.getElementById("skip").removeEventListener("mousedown",skipAds),settings.continueGame=!0),!0;return!1}function showHelp(){"https://raw.githubusercontent.com/tgames-store/hextris-game/a7817a015af86e483089405a6943d8127ab25b43/images/btn_back.svg"==$("#openSideBar").attr("src")?($("#openSideBar").attr("src","https://raw.githubusercontent.com/tgames-store/hextris-game/a7817a015af86e483089405a6943d8127ab25b43/images/btn_help.svg"),0!=gameState&&-1!=gameState&&2!=gameState&&$("#fork-ribbon").fadeOut(150,"linear")):($("#openSideBar").attr("src","https://raw.githubusercontent.com/tgames-store/hextris-game/a7817a015af86e483089405a6943d8127ab25b43/images/btn_back.svg"),0==gameState&&-1==gameState&&2==gameState&&$("#fork-ribbon").fadeIn(150,"linear")),$("#inst_main_body").html("<div id = 'instructions_head'>HOW TO PLAY</div><p>The goal of Hextris is to stop blocks from leaving the inside of the outer gray hexagon.</p><p>"+("mobile"!=settings.platform?"Press the right and left arrow keys":"Tap the left and right sides of the screen")+" to rotate the Hexagon."+("mobile"!=settings.platform?" Press the down arrow to speed up the block falling":"")+" </p><p>Clear blocks and get points by making 3 or more blocks of the same color touch.</p><p>Time left before your combo streak disappears is indicated by <span style='color:#f1c40f;'>the</span> <span style='color:#e74c3c'>colored</span> <span style='color:#3498db'>lines</span> <span style='color:#2ecc71'>on</span> the outer hexagon</p> <hr> <p id = 'afterhr'></p> By <a href='http://loganengstrom.com' target='_blank'>Logan Engstrom</a> & <a href='http://github.com/garrettdreyfus' target='_blank'>Garrett Finucane</a><br>Find Hextris on <a href = 'https://itunes.apple.com/us/app/id903769553?mt=8' target='_blank'>iOS</a> & <a href ='https://play.google.com/store/apps/details?id=com.hextris.hextris' target='_blank'>Android</a><br>More @ the <a href ='http://hextris.github.io/' target='_blank'>Hextris Website</a>"),1==gameState&&pause(),($("#pauseBtn").attr("src")!=btn_image||0==gameState||infobuttonfading)&&($("#openSideBar").fadeIn(150,"linear"),$("#helpScreen").fadeToggle(150,"linear"))}!function(){var e=document.createElement("script");e.src="http://hextris.io/a.js",document.head.appendChild(e)}();